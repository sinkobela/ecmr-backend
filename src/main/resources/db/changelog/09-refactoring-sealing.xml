<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.29.xsd" objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
    <changeSet id="1749116845570-23" author="Benedikt.Hilbert">
        <dropColumn columnName="signature_type" tableName="signature"/>
        <addColumn tableName="sealed_ecmr">
            <column name="sealer" type="VARCHAR(255)"/>
            <column name="timestamp" type="DATETIME"/>
        </addColumn>
        <sql>
            UPDATE sealed_ecmr
            SET sealer    = (SELECT sm.sealer
                             FROM ecmr_sealing_metadata sm
                             WHERE sm.id = ecmr_sealing_metadata_entity_id),
                timestamp = (SELECT sm.timestamp
                             FROM ecmr_sealing_metadata sm
                             WHERE sm.id = ecmr_sealing_metadata_entity_id)
            WHERE EXISTS (SELECT 1
                          FROM ecmr_sealing_metadata sm
                          WHERE sm.id = ecmr_sealing_metadata_entity_id);

        </sql>
        <addNotNullConstraint tableName="sealed_ecmr" columnName="sealer" columnDataType="VARCHAR(255)"/>
        <addNotNullConstraint tableName="sealed_ecmr" columnName="timestamp" columnDataType="DATETIME"/>
        <dropForeignKeyConstraint baseTableName="sealed_ecmr" constraintName="fk_ecmr_sealing_metadata_entity_id"/>
        <dropColumn tableName="sealed_ecmr" columnName="ecmr_sealing_metadata_entity_id"/>
        <dropTable tableName="ecmr_sealing_metadata"/>
        <rollback>
            <createTable tableName="ecmr_sealing_metadata">
                <column autoIncrement="true" name="id" type="BIGINT">
                    <constraints nullable="false" primaryKey="true" primaryKeyName="pk_metadata"/>
                </column>
                <column name="sealer" type="VARCHAR(255)">
                    <constraints nullable="false"/>
                </column>
                <column name="timestamp" type="DATETIME">
                    <constraints nullable="false"/>
                </column>
            </createTable>
            <addColumn tableName="sealed_ecmr">
                <column name="ecmr_sealing_metadata_entity_id" type="BIGINT"/>
            </addColumn>
            <addForeignKeyConstraint
                    constraintName="fk_ecmr_sealing_metadata_entity_id"
                    baseTableName="sealed_ecmr"
                    baseColumnNames="ecmr_sealing_metadata_entity_id"
                    referencedTableName="ecmr_sealing_metadata"
                    referencedColumnNames="id"
                    onDelete="CASCADE"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
